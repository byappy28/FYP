<!doctype html>
<html>
<head>
    <title>Prediction Result</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='result.css') }}">
</head>
<body>
    <div class="result-container">
        <header class="result-header">
            <h1>Prediction Result
                <span class="tooltip">â„¹  <!-- Tooltip for model explanation -->
                    <span class="tooltiptext">
                        The model predicts the likelihood of malignancy.<br>
                        <strong>Benign (class 0):</strong> No cancer detected.<br>
                        <strong>Malignant (class 1):</strong> Potential cancerous region detected.
                    </span>
                </span>
            </h1>
            <form action="{{ url_for('logout') }}" method="post" class="logout-form">  <!-- Logout form -->
                <button type="submit" class="logout-btn">Log Out</button>
            </form>
        </header>
        <!-- Prediction results section -->
        <div class="result-details">
            <p><strong>Predicted Probability:</strong> {{ prob }}</p>
            <p><strong>Predicted Class:</strong>  <!-- Display predicted class based on model output -->
                {% if pred_class == 1 %}
                    Malignant (Class 1)
                {% else %}
                    Benign (Class 0)
                {% endif %}
            </p> <!-- Confidence meter visual -->
            <div class="confidence-meter">
                <div class="confidence-label">Confidence Level:</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceBar"></div>
                </div>
                <div class="confidence-value" id="confidenceValue"></div>
            </div> <!-- Model interpretation message -->
            <div class="interpretation">
                {% if pred_class == 1 %}
                    <p style="color: #e53e3e; font-weight: bold;">
                        Alert: Suspicious malignant regions detected. Recommend thorough review and additional diagnostic workup as appropriate.
                    </p>
                {% else %}
                    <p style="color: #38a169; font-weight: bold;">
                        No significant abnormalities detected.
                    </p>
                {% endif %}
            </div>
        </div>
           <!-- Side-by-side image display -->
        <div class="images-row" style="display:flex; justify-content:center; gap:40px; flex-wrap: wrap;">

            <div class="image-section" style="max-width: 320px; text-align: center;">
                <h3>Original Image</h3>
                {% if filename.lower().endswith('.dcm') %}
                    {% if dicom_preview %} <!-- DICOM file preview -->
                        <img id="originalImg" src="{{ url_for('static', filename='results/' + dicom_preview) }}" alt="DICOM Preview" style="cursor:pointer; border-radius: 8px; max-width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                    {% else %}
                        <p class="error-text">(DICOM file - preview generation failed)</p>
                    {% endif %}
                {% else %} <!-- Normal image preview -->
                    <img id="originalImg" src="{{ url_for('static', filename='uploads/' + filename) }}" alt="Original Image" style="cursor:pointer; border-radius: 8px; max-width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                {% endif %}
                <!-- Download button -->
                <div class="btn-group">
                    {% if filename.lower().endswith('.dcm') and dicom_preview %}
                    <a href="{{ url_for('static', filename='results/' + dicom_preview) }}" download class="btn">Download Original</a>
                    {% else %}
                    <a href="{{ url_for('static', filename='uploads/' + filename) }}" download class="btn">Download Original</a>
                    {% endif %}
                </div>
            </div>
            <!-- Grad-CAM visualization section -->
            <div class="image-section" style="max-width: 320px; text-align: center;">
                <h3>Grad-CAM Visualization</h3>
                <img id="gradcamImg" src="{{ url_for('static', filename='results/' + result_image) }}" alt="Grad-CAM Image" style="cursor:pointer; border-radius: 8px; max-width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <div class="btn-group">
                    <a href="{{ url_for('static', filename='results/' + result_image) }}" download class="btn">Download Grad-CAM</a>
                </div>
            </div>

        </div>
        <!-- Try again button -->
        <div class="actions" style="margin-top: 40px; text-align:center;">
            <a href="{{ url_for('index') }}" class="btn">Try Another Image</a>
        </div>
    </div>

    <footer>
        &copy; 2025 Brandon Yap. All rights reserved.
    </footer>

<script>
        function magnify(imgID, zoom) { // Function to enable magnification on images
        const img = document.getElementById(imgID);
        let glass = document.createElement("DIV");
        glass.setAttribute("class", "img-magnifier-glass");
        img.parentElement.insertBefore(glass, img);

        glass.style.backgroundImage = `url('${img.src}')`;
        glass.style.backgroundSize = (img.width * zoom) + "px " + (img.height * zoom) + "px";

        let bw = 3;
        let w = glass.offsetWidth / 2;
        let h = glass.offsetHeight / 2;
        // Function to move the magnifier glass    
        function moveMagnifier(e) {
            e.preventDefault();
            let pos = getCursorPos(e);
            let x = pos.x;
            let y = pos.y;
            // Prevent the glass from going outside the image
            if (x > img.width - (w / zoom)) { x = img.width - (w / zoom); }
            if (x < w / zoom) { x = w / zoom; }
            if (y > img.height - (h / zoom)) { y = img.height - (h / zoom); }
            if (y < h / zoom) { y = h / zoom; }

            glass.style.left = (x - w) + "px";
            glass.style.top = (y - h) + "px";
            glass.style.backgroundPosition = `-${(x * zoom) - w + bw}px -${(y * zoom) - h + bw}px`;
        }
        // Get cursor position relative to image
        function getCursorPos(e) {
            let a = img.getBoundingClientRect();
            let x = e.pageX - a.left - window.pageXOffset;
            let y = e.pageY - a.top - window.pageYOffset;
            return { x: x, y: y };
        }
        // Show magnifier on mouse enter
        img.addEventListener("mouseenter", function() {
            glass.style.display = "block";
            img.addEventListener("mousemove", moveMagnifier);
        });
        // Hide magnifier on mouse leave
        img.addEventListener("mouseleave", function() {
            glass.style.display = "none";
            img.removeEventListener("mousemove", moveMagnifier);
        });
    }
    window.onload = function() {
        magnify("originalImg", 2);
        magnify("gradcamImg", 2);
    };
    // Script to update confidence bar styling
    document.addEventListener("DOMContentLoaded", function() {
        const rawProb = parseFloat("{{ prob }}");
        const probValue = rawProb * 100;

        const bar = document.getElementById("confidenceBar");
        const valueLabel = document.getElementById("confidenceValue");

        // Set bar width
        bar.style.width = probValue + "%";

        // Color logic: Green (low), Yellow (medium), Red (high)
        if (probValue < 40) {
            bar.style.backgroundColor = "#38a169"; // green
        } else if (probValue < 70) {
            bar.style.backgroundColor = "#d69e2e"; // yellow
        } else {
            bar.style.backgroundColor = "#e53e3e"; // red
        }

        // Show percentage text
        valueLabel.textContent = probValue.toFixed(1) + "%";
    });
</script>
    
</body>
</html>
